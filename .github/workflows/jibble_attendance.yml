name: Jibble Attendance Daily

on:
  schedule:
    # Runs at 00:00 UTC, which is 8:00 AM in the Philippines (PH)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start Date (YYYY-MM-DD, optional, defaults to yesterday)"
        required: false
      end_date:
        description: "End Date (YYYY-MM-DD, optional, defaults to yesterday)"
        required: false

concurrency:
  group: jibble-attendance
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_KEY_B64 }}'
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      - name: Setup gcloud CLI
        # This is needed for the 'bq' command-line tool used in the final step
        uses: google-github-actions/setup-gcloud@v2

      # ---- Jibble â†’ BigQuery ----
      - name: Sync Jibble Attendance to BigQuery
        env:
          # Jibble API credentials and Organization ID from GitHub Secrets
          JIBBLE_API_KEY_ID: ${{ secrets.JIBBLE_API_KEY_ID }}
          JIBBLE_API_KEY_SECRET: ${{ secrets.JIBBLE_API_KEY_SECRET }}
          JIBBLE_ORG_ID: ${{ secrets.JIBBLE_ORG_ID }}

          # Google Cloud and BigQuery configuration
          GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          BQ_DATASET: sbco_ops_jibble # IMPORTANT: Ensure this dataset exists in your BigQuery project
          
          # Date window for the sync, taken from manual trigger inputs if provided
          START_DATE: ${{ github.event.inputs.start_date }}
          END_DATE: ${{ github.event.inputs.end_date }}

          # This is the corrected Jibble REST API endpoint. The script will use this.
          JIBBLE_API_BASE: https://api.jibble.io/api
          JIBBLE_ENTRIES_PATH: /v1/time-entries
        run: python sync_jibble_attendance.py

      - name: MERGE raw data into final table
        run: bq query --quiet --use_legacy_sql=false < merge_final.sql
